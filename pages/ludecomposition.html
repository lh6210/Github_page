title: LUdecomposition - Chapter 2 (2.6) 
date: 2021-10-30 
category: la #la stands for Linear Algebra 
keywords: LUdecomposition, Sympy


<div class="container-fluid line-numbers">

  <!-- anchors -->
  <div class='txt-center mt-3'>
    <div class='right-arrow'>
      <a href="#notes" >NOTES</a> 
    </div>
    <div class="right-arrow">
      <a href="#lab">LAB</a> 
    </div>
  </div>

  <!-- blog body -->
  <div class='mt-5'>

    <div>

      <h6 id="notes">NOTES: </h6>

      <ul class='divGap-0_6em'>
        <li>
          Why are $ L_{31}  = \left( \begin{smallmatrix}
          1 & 0 & 0 \\
          0 & 1 & 0 \\
          l_{31} & 0 & 1
          \end{smallmatrix} \right) $  
          and  $
          E_{31} = \left( \begin{smallmatrix}
          1 & 0 & 0 \\
          0 & 1 & 0 \\
          -l_{31} & 0 & 1
          \end{smallmatrix} \right) $
          inverse to each other?  <br> 


          $\because$   $$
          \begin{flalign}  
          L_{31} * E_{31} &= 
          \begin{bmatrix}
          1 & 0 & 0 \\
          0 & 1 & 0 \\
          l_{31} & 0 & 1
          \end{bmatrix} 
          *
          \begin{bmatrix}
          1 & 0 & 0 \\
          0 & 1 & 0 \\
          -l_{31} & 0 & 1
          \end{bmatrix}
          = I  & \\
          \\
          \text{Or} \\
          \\
          L_{31} * E_{31} * A &= 
          \begin{bmatrix}
          1 & 0 & 0 \\
          0 & 1 & 0 \\
          l_{31} & 0 & 1
          \end{bmatrix}
          *
          \begin{bmatrix}
          1 & 0 & 0 \\
          0 & 1 & 0 \\
          -l_{31} & 0 & 1
          \end{bmatrix}
          *
          \begin{bmatrix}
          & \text{row 1}& \\
          & \text{row 2}& \\
          & \text{row 3}& 
          \end{bmatrix}_{\text{Matrix A}} & \\
          &=
          \begin{bmatrix}
          1 & 0 & 0 \\
          0 & 1 & 0 \\
          l_{31} & 0 & 1
          \end{bmatrix}
          *
          \begin{bmatrix}
          & \text{row 1} & \\
          & \text{row 2}& \\
          & \text{row 3 } - l_{31} * \text{row 1}& 
          \end{bmatrix}  \\
          &=
          \begin{bmatrix}
          & \text{row 1}& \\
          & \text{row 2}& \\
          & \text{row 3}& 
          \end{bmatrix}_{\text{Matrix A}} = A \\
          \end{flalign}
          $$ 
        </li>

        <li class='mt-2'>
          Why does $L=E_{21}^{-1}*E_{31}^{-1}*E_{32}^{-1}$ have advantage over $E = E_{32}*E_{31} *E_{21}$?  <br>
          $\because$

          $$
          \begin{flalign}
          E &= E_{32}*E_{31} *E_{21} & &  &\\  <!-- first line -->
            &= \begin{bmatrix}
            1 & 0 & 0   \\  
            0 & 1 & 0  \\
            0 & -l_{32} & 1  
            \end{bmatrix} * 
          \begin{bmatrix}
            1 & 0 & 0  \\
            0 & 1 & 0  \\
            -l_{31} & 0 & 1 
            \end{bmatrix}  *
            \begin{bmatrix} 1 & 0 & 0 \\
            -l_{21} & 1 & 0 \\
            0 & 0 & 1
            \end{bmatrix}  & & &\\  <!-- second line -->
          \phantom{L_{31} * E_{31} * A } &= 
            \begin{bmatrix}
            1 & 0 & 0   \\  
            0 & 1 & 0  \\ 
            0 & -l_{32} & 1  
            \end{bmatrix} * 
          \begin{bmatrix}
            1 & 0 & 0  \\
            -l_{21} & 1 & 0  \\
            -l_{31} & 0 & 1 
            \end{bmatrix} & & \text{(1)} &\\  <!-- third line -->
          &=
            \begin{bmatrix}
            1 & 0 & 0   \\  
            -l_{21} & 1 & 0  \\ 
            \underline{-l_{31} + l_{21} * l_{32}} & -l_{32} & 1  
            \end{bmatrix} & & \text{(2)} & \\
            \end{flalign}
           $$ 

           (1) Matrix multiplication mixed up all three numbers below. <br>
            (2) The entry of \(E_{31}\) is an algebraic combination of three elements.

           $$
           \begin{flalign}
           L &= E_{21}^{-1} * E_{31}^{-1} *E_{32}^{-1} & & &\\  <!-- first line -->
            &= \begin{bmatrix}
            1 & 0 & 0   \\  
            l_{21} & 1 & 0  \\ 
            0 & 0 & 1  
            \end{bmatrix}  * 
          \begin{bmatrix}
            1 & 0 & 0  \\
            0 & 1 & 0  \\
            l_{31} & 0 & 1 
            \end{bmatrix}  *
            \begin{bmatrix}
            1 & 0 & 0 \\
            0 & 1 & 0 \\
            0 & l_{32} & 1
            \end{bmatrix} & && \\   <!-- second line -->
          \phantom{L_{31} * E_{31} * A } &= 
            \begin{bmatrix}
            1 & 0 & 0   \\  
            l_{21} & 1 & 0  \\ 
            0 & 0 & 1  
            \end{bmatrix} * 
          \begin{bmatrix}
            1 & 0 & 0  \\
            0 & 1 & 0  \\
            l_{31} & l_{32} & 1 
            \end{bmatrix}  & & & \\   <!-- third line -->
          &=
            \begin{bmatrix}
            1 & 0 & 0   \\  
            l_{21} & 1 & 0  \\ 
            l_{31} & l_{32} & 1  
            \end{bmatrix}   & &\text{(3)} & \\
            \end{flalign}
          $$

          (3) Each multiplier \(l_{ij}\) goes directly into its $i, j$ position unchanged, which is what we like.
        </li>

        <li>
          Forward and backward solving $Ax = b$:
          <ol>
            <li>
              Given $Ax = b  \Rightarrow  LUx = b \Rightarrow L(Ux) = b $. Let $ Ux = c $, then solve $Lc = b$ ($L$ is the lower triangle Matrix, we solve $L_1, L_2, \dots , L_n $ forward)  ; 
            </li>
            <li> solve $ Ux = c $. ($U$ is the upper triangle Matrix, we solve $U_n, U_{n-1}, \dots , U_1$ backward)</li>
          </ol>

        </li>

        <li>
          Better balance of $LDU$: The $LU$ factorization of $A = LU$ yields lower triangular Matrix $L$ and upper triangular Matrix $U$. While $L$ has $1$ on its diagonal, usually $U$ doesn't. Therefore, we futher factor $U = DU'$.
          $$
          U = \left( \begin{matrix}  d_1 & U_{12} & U_{13} & \cdots & U_{1n} \\  & d_2 & U_{23} & \cdots & U_{2n}  \\ & & d_3 & \cdots  & U_{3n} \\ &&& \ddots & \vdots  \\  &&&& d_n            \end{matrix} \right)
          = DU'
          = \left( \begin{matrix} d_1 &&&& \\ & d_2 &&& \\ && d_3 &&   \\ &&& \ddots & \\ &&&& d_n         \end{matrix} \right)
          \left( \begin{matrix}  1 & \frac{U_{12}}{d_1} & \frac{U_{13}}{d_1} & \cdots & \frac{U_{1n}}{d_1} \\ & 1 & \frac{U_{23}}{d_2} & \cdots & \frac{U_{2n}}{d_2} \\ && 1 & \cdots   &  \frac{U_{3n}}{d_3}  \\ &&& \ddots & \vdots \\ &&&& 1         \end{matrix}  \right)



          $$


        </li>




      </ul>
    </div>

    <div class='my-5 divGap-1_6em'>
      <h6 id='lab'>LAB:</h6>

      <div>
        <div>Preliminary Setup:</div>
        <pre><code class='language-python'>
          from sympy.interactive.printing import init_printing 
          init_printing(use_unicode=True)
          from sympy.matrices import Matrix 
          from sympy import symbols, shape, eye, sympify, Rational
          </code></pre>
      </div>
      

      <div class='divGap-0_6em'>
        <div>
          1) &#128037  Modify Sympy's LUdecomposition method so that it returns L, D, U instead of just L and U.
        </div>

        <div>
          According to Sympy's reference,  <a href="https://docs.sympy.org/latest/modules/matrices/matrices.html#matrix-functions-reference">LUdecomposition</a> returns (L, U, perm) where L is a lower triangular matrix with unit diagonal, U is an upper triangular matrix, and perm is a list of row swap index pairs. See the example below:
        </div>

        <pre><code class="language-python">
           A =  Matrix([[4, 3], [6, 3]])
           A.LUdecomposition()
          </code></pre>

          $$ \left( \left( \begin{matrix} 1 & 0 \\ \frac{3}{2} & 1  \end{matrix} \right) , \left( \begin{matrix}  4 & 3 \\ 0 & -\frac{3}{2}  \end{matrix} \right), \left[ \right] \right) $$


        <div>
          Our modification LU2() will work upon the return value of LUdecomposition(), precisely $U$, to get us $A = LDU$. 
        </div>
        <div>
          And we will check LU2() with a special example: symmetric Matrix. The observation is that symmetric Matrices always have $A = LDU = LDL^T$.

        </div>

        <pre><code class="language-python">
        def LU2(A):
            L, U, P = A.LUdecomposition()
            r = U.rank()
            m, n = shape(U)
            D = eye(r)
            for i in range(r):
                pivot = U[i, i]
                D[i, i] = pivot
                for j in range(i, n):
                    U[i, j] = U[i, j] / sympify(pivot)    # sympify makes the quotient of the two integers an exact rational number
            return L, D, U, P  </code></pre>

        <div>
          Let's make a symmetric Matrix and check its $LU$ and $LDL^T$ decompositions.
        </div>

        <pre><code class="language-python">
          B = Matrix([[1, 0, 3], [-2, 3, 5], [Rational(1, 3), 0, -3]])
          S = B.T*B    # this step makes a symmetric matrix S; another trick is B*B.T
          S.LUdecomposition() 
        </code></pre>

        $$ \left( \left( \begin{matrix} 1 & 0 & 0 \\ -\frac{27}{23} & 1  & 0 \\ -\frac{36}{23} & \frac{43}{15} & 1 \end{matrix} \right) , \left( \begin{matrix}  \frac{46}{9} & -6 & -8 \\ 0 & \frac{45}{23} & \frac{129}{23} \\ 0 & 0 & \frac{72}{5} \end{matrix} \right), \left[ \right] \right) $$

        <div>
          Here's the result of LU2's output:
        </div>

        <pre><code class="language-python">
        LU2(S)
        </code></pre>

        $$ \left( \left( \begin{matrix} 1 & 0 & 0 \\ -\frac{27}{23} & 1  & 0 \\ -\frac{36}{23} & \frac{43}{15} & 1 \end{matrix} \right) , \left( \begin{matrix} \frac{46}{9} & 0 & 0 \\ 0 & \frac{45}{23} & 0 \\ 0 & 0 & \frac{72}{5}   \end{matrix} \right)  \left( \begin{matrix} 1  & -\frac{27}{23} & -\frac{36}{23} \\ 0 & 1 & \frac{43}{15} \\ 0 & 0 & 1 \end{matrix} \right), \left[ \right] \right) $$

        <div>
          In this particular case (check symmetric Matrices' $L*D*L^T $ decomposition), we could see clearly that the rightmost Matrix is the transpose of L (the leftmost Matrix).
        </div>
      </div>


      <div class='divGap-0_6em'>
        <div>
          2) &#128037 LUdecompose rectangular shaped Matrices A 
        </div>

        <div>
          Sympy's LUdecomposition is a really sharp tool that it deals with both square and rectangular Matrices. While we may not find decomposing rectangular Matrics productive, let's just play for fun. 
        </div>

        <div>
          For this practice, I picked one 2 by 3 Matrix A and one 3 by 2 Matrix B. I am going to use both Sympy's LUdecomposition and our lightly modified LU2 method to see the Matrix decomposition again.
        </div>

        <img src="../static/lu4_2.png" class="img-fluid"  alt="rectangular matrices">
        <img src="../static/lu5_2.png" class="img-fluid"  alt="rect matrices2">

        <div>
          One takeaway I got from this experiment is that A and D seem to share the same shape and rank, while L is always square and full rank.
        </div>

        <div>
          This is the end of this article, and thanks for reading.
        </div>

      </div>



    </div>

  </div>




</div>

